{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "./taskframeconstraint.json",
    "title": "Task frame constraint",
    "description": "A constraint specification based on the task frame formalism",
    "type": "object",
    "format": "grid-strict",
    "properties": {
        "name": {
            "title": "Name",
            "type": "string",
            "pattern" : "^[a-zA-Z][a-zA-Z0-9]*$",
            "propertyOrder": 1,
            "options": {
                "grid_columns": 3
            }
        },
        "description": {
            "title": "Description",
            "type": "string",
            "format": "string",
            "propertyOrder": 2,
            "options": {
                "grid_columns": 9,
                "grid_break": true
            }
        },
        "parent": {
            "title": "Parent",
            "description": "The task frame in which the constraints are expressed",
            "type": "string",
            "propertyOrder": 8,
            "options": {
                "grid_columns": 4
            },
            "watch": {
                "node": "worldmodel.nodes"
            },
            "enumSource": [
                {
                    "source": "node",
                    "value": "{{item.name}}"
                }
            ]
        },
        "child": {
            "title": "Child",
            "description": "Forces and velocities are expressed between parent and child",
            "type": "string",
            "propertyOrder": 9,
            "options": {
                "grid_columns": 4,
                "grid_break" : true
            },
            "watch": {
                "node": "worldmodel.nodes"
            },
            "enumSource": [
                {
                    "source": "node",
                    "value": "{{item.name}}"
                }
            ]
        },
        "sensor": {
            "title":"Force sensor",
            "type": "object",
            "description": "Whether sensor is available and whether it measures at child-branch or parent-branch. Make sure there is no other contact between the force sensor and the parent or child.  The measured forces are the forces that are acting upon the force sensor by the child.",
            "propertyOrder": 19,
            "default" : {"forcesensor_type":"none"},
            "oneOf": [
                {
                    "title":"Force sensor not specified",
                    "type": "object",
                    "format": "grid-strict",
                    "properties": {
                        "forcesensor_type": {                   
                            "type": "string",
                            "enum": [
                                "none"
                            ],
                            "options": {
                                "hidden" : true
                            }
                        }
                    },
                    "required": [
                        "forcesensor_type"
                    ],
                    "additionalProperties": false,
                    "options": {
                        "disable_collapse": true,
                        "disable_edit_json": true,
                        "disable_properties": true
                    }
                },                    
                {
                    "title":"Force sensor available",
                    "type": "object",
                    "format": "grid-strict",                    
                    "properties": {
                        "forcesensor_type": {
                            "type": "string",
                            "enum": [
                                "available"
                            ],
                            "options": {
                                "hidden" : true
                            }
                        },
                        "forcesensor_frame": {
                            "title": "Force sensor",
                            "description": "Frame at which the force sensor is located (empty if not used)",
                            "type": "string",
                            "propertyOrder": 12,
                            "options": {
                                "grid_columns": 3
                            },
                            "watch": {
                                "node": "worldmodel.nodes"
                            },
                            "enumSource": [
                                {
                                    "source": "node",
                                    "value": "{{item.name}}"
                                }
                            ]
                        },
                        "gravity_frame": {
                            "title": "Gravity",
                            "description": "Frame in which gravity is expressed",
                            "type": "string",
                            "propertyOrder": 15,
                            "options": {
                                "grid_columns": 3
                            },
                            "watch": {
                                "node": "worldmodel.nodes"
                            },
                            "enumSource": [
                                {
                                    "source": "node",
                                    "value": "{{item.name}}"
                                }
                            ]
                        },
                        "gravity_direction": {
                            "title": "Gravity Direction",
                            "description": "Direction in which the gravity is expressed",
                            "type": "string",
                            "enum": [
                                "X",
                                "Y",
                                "Z"
                            ],
                            "propertyOrder": 16,
                            "options": {
                                "grid_columns": 3
                            }
                        },
                        "stiffness": {
                            "title": "Stiffness",
                            "description": "Estimated stiffness of the contact in [N/mm], scalar value",
                            "type": "number",
                            "propertyOrder": 20,
                            "default": 10,
                            "format": "lua",
                            "options": {
                                "grid_columns": 3,
                                "grid_break": true
                            }
                        }
                    },
                    "required": [
                        "forcesensor_type",
                        "forcesensor_frame",
                        "gravity_direction",
                        "gravity_frame",
                        "stiffness"
                    ],
                    "additionalProperties": false,
                    "options": {
                        "disable_collapse": true,
                        "disable_edit_json": true,
                        "disable_properties": true
                    }
                }       
            ],
            "options": {
                "grid_columns": 12,
                "grid_break" : true
            }                     
        },
        "constraints": {
            "type": "array",
            "format": "tabs",
            "title": "List of constraints",
            "propertyOrder": 30,
            "items": {
                "type": "object",
                "headerTemplate": "{{self.constrainttype}}-{{self.direction}}",
                "oneOf": [
                    {
                        "title": "vel. constraint",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "vel"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 3
                                }
                            },
                            "desvel": {
                                "title": "des. vel.",
                                "description": "Desired velocity in [m/s] [LUA expression]",
                                "type": "string",
                                "format": "lua",
                                "default": "0",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "desvel",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    },
                    {
                        "title": "force constraint",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "force"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 3
                                }
                            },
                            "desforce": {
                                "title": "des. force",
                                "description": "Desired force in [N] [LUA expression]",
                                "type": "string",
                                "format": "lua",
                                "default": "0",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            },
                            "gain": {
                                "$ref": "#/definitions/gain",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "desforce",
                            "gain",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    },
                    {
                        "title": "rot. vel. constraint",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "rotvel"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 3
                                }
                            },
                            "desrotvel": {
                                "title": "desired rot. vel.",
                                "description": "Desired velocity in [rad/s]",
                                "type": "string",
                                "format": "lua",
                                "default": "0",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "desrotvel",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    },
                    {
                        "title": "moment constraint",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "moment"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 3
                                }
                            },
                            "desmoment": {
                                "title": "des. moment",
                                "description": "Desired moment in [Nm] [LUA expression]",
                                "type": "string",
                                "format": "lua",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            },
                            "gain": {
                                "$ref": "#/definitions/gain",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 4,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "desmoment",
                            "gain",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    },
                    {
                        "title": "tracking orientation on force",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "trackforce"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "title": "rot. axis",
                                "description": "Rotation axis around which to rotate to align the force",
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 6
                                }
                            },
                            "alignTo-expr" : {
                                "title" : "align to",
                                "description" : "Rotate such that the measured force will align to this vector (should not be equal to rot. axis)",
                                "type" : "string",
                                "default" : "[0,0,1]",
                                "options": {
                                    "grid_columns": 6,
                                    "grid_break": true
                                }            
                            },   
                            "alignTo" : {
                                "title" : "align to",
                                "type" : "array",
                                "default" : [0,0,1],
                                "options": {
                                    "hidden": true
                                }             
                            }, 
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5
                                }
                            },
                            "adaptiveGain": {
                                "$ref": "#/definitions/adaptiveGain",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 3,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "alignTo",
                            "alignTo-expr",
                            "adaptiveGain",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    },
                    {
                        "title": "tracking orientation on velocity",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "trackvel"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "title": "rot. axis",
                                "description": "Rotation axis around which to rotate to align the velocity",
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 6
                                }
                            },
                            "alignTo-expr" : {
                                "title" : "align to",
                                "description" : "Rotate such that the measured force will align to this vector (should not be equal to rot. axis)",
                                "type" : "string",
                                "default" : "[0,0,1]",
                                "options": {
                                    "grid_columns": 6,
                                    "grid_break": true
                                }            
                            },   
                            "alignTo" : {
                                "title" : "align to",
                                "type" : "array",
                                "default" : [0,0,1],
                                "options": {
                                    "hidden": true
                                }             
                            }, 
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5
                                }
                            },
                            "adaptiveGain": {
                                "$ref": "#/definitions/adaptiveGain",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 3,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "alignTo",
                            "adaptiveGain",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    },
                    {
                        "title": "pos. constraint",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "pos"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "title": "direction",
                                "description": "Direction to constraint (to zero)",
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            },
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5
                                }
                            },
                            "gain": {
                                "$ref": "#/definitions/gain",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 3,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "gain",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    },
                    {
                        "title": "orient. constraint",
                        "type": "object",
                        "format": "grid-strict",
                        "properties": {
                            "constrainttype": {
                                "type": "string",
                                "enum": [
                                    "orient"
                                ],
                                "options": {
                                    "hidden": true
                                }
                            },
                            "direction": {
                                "title": "direction",
                                "description": "Direction to constraint (to zero)",
                                "type": "string",
                                "enum": [
                                    "X",
                                    "Y",
                                    "Z"
                                ],
                                "options": {
                                    "grid_columns": 5,
                                    "grid_break": true
                                }
                            },
                            "weight": {
                                "$ref": "#/definitions/weight",
                                "options": {
                                    "grid_columns": 5
                                }
                            },
                            "gain": {
                                "$ref": "#/definitions/gain",
                                "options": {
                                    "grid_columns": 4
                                }
                            },
                            "priority": {
                                "$ref": "#/definitions/priority",
                                "options": {
                                    "grid_columns": 3,
                                    "grid_break": true
                                }
                            }
                        },
                        "required": [
                            "constrainttype",
                            "direction",
                            "gain",
                            "weight",
                            "priority"
                        ],
                        "additionalProperties": false,
                        "options": {
                            "disable_collapse": true,
                            "disable_edit_json": true,
                            "disable_properties": true
                        }
                    }
                ]
            },
            "options": {
                "disable_collapse": true
            }
        },
        "monitor": {
            "title": "Monitoring endconditions",
            "description": "A Lua boolean expression describing when to stop.  Available variables are 'duration', 'pathlength', 'forcex', 'forcey', 'forcez', 'momentx','momenty', and 'momentz'",
            "type": "string",
            "format": "lua",
            "default": "false",
            "options": {
                "grid_columns": 12,
                "grid_break": true
            }
        }
    },
    "required": [
        "name",
        "parent",
        "child",
        "sensor",
        "constraints",
        "monitor"
    ],
    "additionalProperties": false,
    "definitions": {
        "priority": {
            "type": "number",
            "enum": [
                0,
                2
            ],
            "description": "Priority of the underlying constraint",
            "default": 2
        },
        "weight": {
            "description": "Weight of the underlying constraint (not relevant for priority==0) >=0, [LUA expression]",
            "type": "string",
            "format": "lua",
            "mininimum": 0,
            "default": 1
        },
        "gain": {
            "title": "control gain",
            "type": "number",
            "description": "Gain (inverse of the time constant) for the constraint",
            "minimum": 0,
            "default": 4
        },
        "adaptiveGain": {
            "title": "adaptive control gain",
            "type": "number",
            "description": "Gain (inverse of the time constant) for the tracking constraint",
            "minimum": 0,
            "default": 1
        }
    },
    "options": {
        "disable_collapse": true,
        "disable_edit_json": true,
        "disable_properties": true
    }
}